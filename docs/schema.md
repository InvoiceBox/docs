---
layout: nocompress
nav_order: 2
title: "Схема взаимодействия"
---

# Схема взаимодействия с ИнвойсБокс API v3

## Процесс создания заказа и оплаты

<div class="mermaid">
sequenceDiagram
    autonumber
    participant Покупатель
    participant Магазин
    participant ИнвойсБокс 
    participant Онлайн касса
    rect rgb(204, 245, 204)
      Покупатель->>Магазин: Создает заказ
      Магазин->>ИнвойсБокс: Вызов метода создания заказа
      ИнвойсБокс->>Магазин: Идентификатор заказа и ссылка на оплату
      Магазин->>Покупатель: Перенаправление на платёжную страницу
      Покупатель-->>ИнвойсБокс: Взаимодействие с платёжной страницей, получение счёта
      Покупатель->>ИнвойсБокс: Оплата счёта
      ИнвойсБокс->>Покупатель: Перенаправление покупателя на сайт магазина
      ИнвойсБокс->>Онлайн касса: Регистрация чека "предоплата 100%"
      ИнвойсБокс->>Покупатель: Предоставление чека "предоплата 100%"
      ИнвойсБокс->>Магазин: Уведомление об успешной оплате
    end
</div>

1. Покупатель оформляет заказ на сайте Магазина и выбирает способ оплаты через систему &laquo;ИнвойсБокс&raquo;.
1. Магазин создает в системе &laquo;ИнвойсБокс&raquo; заказ [через метод API](/docs/order/create/).
1. Система возвращает ссылку на платёжную страницу для оплаты заказа.
1. Магазин перенаправляет покупателя по полученной ссылке.
1. Покупатель заполняет необходимые для оплаты сведения и получет счёт для оплаты.
1. Покупатель оплачивает счёт.
1. Система &laquo;ИнвойсБокс&raquo; перенаправляет покупателя обратно на сайт Магазина.
1. Система &laquo;ИнвойсБокс&raquo; формирует и регистрирует чек "предоплата 100%" в [онлайн кассе](/docs/fz54/) (при оплате физическим лицом).
1. Система &laquo;ИнвойсБокс&raquo; направляет чек "предоплата 100%" покупателю (физическому лицу).
1. Система &laquo;ИнвойсБокс&raquo; оповещает Магазин об успешной оплате заказа.

## Процесс отгрузки и оформления чека "полный расчёт"

<div class="mermaid">
sequenceDiagram
    autonumber
    participant Покупатель
    participant Магазин
    participant ИнвойсБокс 
    participant Онлайн касса
    rect rgb(204, 245, 204)
      Магазин->>ИнвойсБокс: Вызов метода отгрузки по заказу
      ИнвойсБокс->>Онлайн касса: Регистрация чека "полный расчёт"
      ИнвойсБокс->>Покупатель: Предоставление чека "полный расчёт"
    end
</div>


1. В случае, если Магазин оказывает услугу или продаёт товар, Магазин направляет запрос отгрузки в систему &laquo;ИнвойсБокс&raquo; по факту оказания услуги или факту отгрузки товара курьерской службой/службе доставки или покупателю. Если услуга оказывается онлайн, отгрузка по заказу может быть установлена автоматически.
1. Система &laquo;ИнвойсБокс&raquo; формирует и регистрирует чек "полный расчёт" в [онлайн кассе](/docs/fz54/) (при оплате физическим лицом).
1. Система &laquo;ИнвойсБокс&raquo; направляет чек "полный расчёт" покупателю (физическому лицу).

## Процесс оформления возврата

<div class="mermaid">
sequenceDiagram
    autonumber
    participant Покупатель
    participant Магазин
    participant ИнвойсБокс 
    participant Онлайн касса
    rect rgb(204, 204, 255)
      Покупатель->>Магазин: Обращается за возвратом по заказу
      Магазин-->ИнвойсБокс: Получение списка позиций в заказе
      Магазин->>ИнвойсБокс: Вызов метода оформления возврата
      ИнвойсБокс->>Покупатель: Осуществление возврата денежных средств
      ИнвойсБокс->>Онлайн касса: Регистрация чека "возврат"
      ИнвойсБокс->>Покупатель: Предоставление чека "возврат"
    end
</div>

1. Покупатель обращается в Магазин для оформления возврата заказа.
1. Опционально, Магазин запрашивает [через метод API](/docs/refund/get/) доступные к возврату позиции в заказе.
1. Магазин создает возврат в системе &laquo;ИнвойсБокс&raquo; [через метод API](/docs/refund/create/).
1. Система &laquo;ИнвойсБокс&raquo; осуществляет возврат денежных средств покупателю.
1. Система &laquo;ИнвойсБокс&raquo; формирует и регистрирует чек "возврат" в [онлайн кассе](/docs/fz54/) (при оплате физическим лицом).
1. Система &laquo;ИнвойсБокс&raquo; направляет чек "возврат" покупателю (физическому лицу).

---

[Читать далее &raquo;](/docs/fz54){: .btn .btn-primary .fs-5 .mb-4 .mb-md-0 .mr-2 }
