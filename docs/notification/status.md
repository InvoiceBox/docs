---
layout: default
nav_order: 1
title: "По умолчанию"
parent: "Обработка уведомлений"
---

# Уведомление по умолчанию

Если в настройках Магазина была активирована опция отправки автоматических уведомлений о смене
статуса Заказа, то при поступлении оплаты в пользу Заказа, система &laquo;ИнвойсБокс&raquo;
осуществит запрос на специальный URL, который указан в настройках Магазина.

На указанный URL будет осуществлен `POST` запрос в теле которого будет находиться объект [OrderNotification](#ordernotification).

## OrderNotification

| Свойство        | Обязательное | Тип         | Описание |
| --------------- | -------------|------------ | -------- |
| id              | да           | string      | Идентификатор заказа в системе &laquo;ИнвойсБокс&raquo;, например: `01771534-1a57-f184-dee3-ebeb91dded75`
| status          | да           | string enum | Статус заказа, например: `completed`
| merchantId      | да           | string      | Идентификатор магазина, например: `01771534-1a57-f184-dee3-ebeb91dded76`
| merchantOrderId | да           | string      | Идентификатор заказа в учётной системе магазина, например: `O-12345`
| amount          | да           | float       | Сумма заказа, например: `19658.45`
| currencyId      | да           | string enum | Валюта заказа, например: `RUB`
| createdAt       | да           | datetime    | Дата создания заказа, например: `2020-12-22T00:00:00+00:00`


Заказ считается оплаченным, если его статус равен `completed`. В этом случае Магазин должен сверить
сумму Заказа в запросе с суммой Заказа в своей системе учёта. Если не совпадает, в обработке запроса
нужно отказать и вернуть ошибку.

# Формат ответа

В случае успешности обработки запроса веб-сервис Магазина должен вернуть объект [NotificationSuccess](#notificationsuccess), а в случае ошибки - [NotificationError](#notificationerror).
HTTP код в обоих случаях должен быть равен 200. Запросы с кодом отличные от 200 считаются ошибочными. Так же ошибочными считаются ответы, не содержащий валидный json.

## NotificationSuccess

| Свойство        | Обязательное | Тип         | Описание |
| --------------- | -------------|------------ | -------- |
| status          | да           | string      | В случе успешной обработки допустимо только одно значение - `success`

Пример объекта NotificationSuccess:
```json 
{
  "status" : "success"
}
```


## NotificationError

| Свойство        | Обязательное | Тип         | Описание |
| --------------- | -------------|------------ | -------- |
| status          | да           | string enum | В случае ошибки обработки запроса допустимо только одно значение - `error`
| code            | нет          | string enum | Код ошибки - значение из справочника [NotificationErrorCode](#notificationerrorcode), по умолчанию `out_of_service`
| message         | нет          | string      | Детальное описание ошибки в текстовом формате

Пример объекта NotificationError:
```json 
{
  "status" : "error",
  "code" : "order_wrong_amount",
  "message" : "Сумма заказа не соответствует сумме оплаты"
}
```


## NotificationErrorCode

| Код ошибки            | Описание |
| --------------------- | -------- |
|`out_of_service`       | Техническая ошибка обработки запроса веб сервером Магазина, при получении этого кода ошибки система &laquo;ИнвойсБокс&raquo; будет пытаться повторить этот запрос еще 10 раз в течение последующих суток.
|`order_wrong_amount`   | Сумма заказа в Магазине не соответствует сумме заказа в уведомлении
|`order_already_paid`   | Заказ уже оплачен другим инструментом оплаты :warning:
|`order_not_found`      | Заказ не найден в учётной системе Магазина
|`signature_error`      | Ошибка проверки подписи запроса

:warning: Обратите внимание, в случае, если аналогичный запрос от системы &laquo;ИнвойсБокс&raquo; на оплату уже был обработан ранее успешно и заказ был отмечен как оплаченный, то в этом случае следует вернуть статус успешной обработки `success`.
В случае, если заказ был оплачен ранее под другим идентификатором системы &laquo;ИнвойсБокс&raquo; или иным платёжным инструментом, то следует вернуть ошибку `order_already_paid`.

## Время выполнения запроса

Существует лимит ожидания ответа от веб-сервера Магазина на запросы уведомления, который составляет 20 секунд.
Запросы отрабатывающие дольше этого значения считаются ошибочными.

## Подпись запроса
При обработке запроса уведомления Магазину необходимо проверить его целостность. 
Для этого необходимо сформировать подпись тела входящего запроса и сравнить со значением из заголовка `X-Signature`. Если эти значения не совпадают, необходимо сформировать ответ [NotificationError](#notificationerror) с [NotificationErrorCode](#notificationerrorcode) `signature_error`.
Электронная подпись формируется путем криптографического преобразования содержимого тела запроса с использованием ключа и алгоритма выбранных в настройках уведомлений.

---

[Читать далее &raquo;](/docs/dictionary){: .btn .btn-primary .fs-5 .mb-4 .mb-md-0 .mr-2 }
